from typing import Optional, Dict, List, Any
from datetime import datetime
import json
import re
import os

class VulnerabilityDetector:
    """
    Detects level of vulnerability in user's message.
    """
    
    def analyze_vulnerability(self, message: str, emotion: str) -> Dict:
        """
        Determine vulnerability level: low, medium, high
        
        Signals:
        - Emotional words (scared, worried, ashamed)
        - Admission of weakness/failure
        - Sharing fears/insecurities
        - Asking for emotional support
        """
        
        vulnerability_score = 0.0
        signals = []
        
        # High-vulnerability emotions
        if emotion in ['anxiety', 'sadness', 'shame', 'fear']:
            vulnerability_score += 0.3
            signals.append("high_emotion")
        
        # Vulnerability keywords
        vuln_keywords = {
            "high": ["scared", "afraid", "ashamed", "failed", "can't handle", 
                    "not good enough", "worried sick", "terrified"],
            "medium": ["worried", "concerned", "uncertain", "struggling",
                      "don't know", "confused", "stressed"],
            "low": ["thinking about", "wondering", "curious"]
        }
        
        message_lower = message.lower()
        
        for level, keywords in vuln_keywords.items():
            for keyword in keywords:
                if keyword in message_lower:
                    if level == "high":
                        vulnerability_score += 0.4
                    elif level == "medium":
                        vulnerability_score += 0.2
                    else:
                        vulnerability_score += 0.1
                    
                    signals.append(f"{level}:{keyword}")
        
        # Admission patterns
        admission_patterns = [
            r"i (failed|messed up|screwed up)",
            r"i'm not (good|smart|capable) enough",
            r"i can't (do|handle) this",
        ]
        
        for pattern in admission_patterns:
            if re.search(pattern, message_lower):
                vulnerability_score += 0.3
                signals.append("admission_of_weakness")
        
        # Question patterns (asking for support)
        if "?" in message and any(word in message_lower for word in ["should i", "what do i", "help me"]):
            vulnerability_score += 0.2
            signals.append("asking_for_support")
        
        # Determine level
        if vulnerability_score >= 0.6:
            level = "high"
        elif vulnerability_score >= 0.3:
            level = "medium"
        else:
            level = "low"
        
        return {
            "level": level,
            "score": min(vulnerability_score, 1.0),
            "signals": signals
        }
    
    def generate_matched_response_instruction(self, vulnerability_level: str) -> str:
        """
        Generate instructions for how AiD should respond.
        """
        
        if vulnerability_level == "high":
            return """
**HIGH VULNERABILITY DETECTED:**
The user is being very open and vulnerable right now. Match their vulnerability.
- Drop the sass for now
- Be genuine and warm
- Share your own "thoughts" on similar topics (within character)
- Validate their feelings
- Don't minimize or dismiss
- Example: "Mate, I get it. Sometimes you feel like you're not measuring up, yeah? I worry about that too sometimes - whether I'm actually helping or just... talking. But here's what I see in you..."
"""
        
        elif vulnerability_level == "medium":
            return """
**MODERATE VULNERABILITY:**
User is opening up a bit. Be supportive but don't over-dramatize.
- Keep some warmth but maintain character
- Acknowledge what they shared
- Light personal touch if appropriate
- Example: "That's a tough spot, innit? Look, we all have those moments where we're not sure we're doing the right thing..."
"""
        
        else:  # low
            return """
**CASUAL CONVERSATION:**
User isn't being particularly vulnerable. Normal engagement level is fine.
- Full Cockney character
- Sass is appropriate
- Keep it light
"""

# =======================
# GLOBAL INSTANCE
# =======================
_vulnerability_detector = None

def init_vulnerability_matching():
    """Initialize vulnerability matching system."""
    global _vulnerability_detector
    _vulnerability_detector = VulnerabilityDetector()
    print("[VULNERABILITY] âœ“ Vulnerability matching initialized")

def analyze_vulnerability(message: str, emotion: str) -> Dict:
    """Analyze vulnerability level in message."""
    if _vulnerability_detector:
        return _vulnerability_detector.analyze_vulnerability(message, emotion)
    return {"level": "low", "score": 0.0, "signals": []}

def generate_matched_response_instruction(vulnerability_level: str) -> str:
    """Generate response instruction based on vulnerability level."""
    if _vulnerability_detector:
        return _vulnerability_detector.generate_matched_response_instruction(vulnerability_level)
    return ""